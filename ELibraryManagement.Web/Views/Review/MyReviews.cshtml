@model List<ReviewViewModel>

@{
    ViewData["Title"] = "Đánh giá của tôi";
}

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>
            <i class="fas fa-star text-warning me-2"></i>Đánh giá của tôi
        </h3>
        <a asp-controller="Book" asp-action="MyBooks" class="btn btn-outline-primary">
            <i class="fas fa-book me-1"></i>Sách của tôi
        </a>
    </div>

    @if (Model == null || !Model.Any())
    {
        <!-- Empty State -->
        <div class="text-center py-5">
            <div class="empty-state">
                <i class="fas fa-star-o fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">Chưa có đánh giá nào</h4>
                <p class="text-muted">
                    Bạn chưa đánh giá cuốn sách nào. Hãy trả sách và viết đánh giá để chia sẻ trải nghiệm với cộng đồng.
                </p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-primary mt-3">
                    <i class="fas fa-search me-1"></i>Khám phá sách
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Reviews List -->
        <div class="row">
            @foreach (var review in Model)
            {
                <div class="col-md-12 mb-4">
                    <div class="card shadow-sm review-card">
                        <div class="card-body">
                            <div class="row">
                                <!-- Book Info -->
                                <div class="col-md-2">
                                    <img src="@(string.IsNullOrEmpty(review.BookCoverUrl) ? "/images/no-cover.jpg" : review.BookCoverUrl)" 
                                         alt="@review.BookTitle" 
                                         class="img-fluid rounded shadow-sm"
                                         style="max-height: 120px; object-fit: cover;">
                                </div>
                                
                                <!-- Review Content -->
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="mb-1">
                                            <a asp-controller="Home" asp-action="BookDetail" asp-route-id="@review.BookId" 
                                               class="text-decoration-none">
                                                @review.BookTitle
                                            </a>
                                        </h5>
                                        <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                                    </div>
                                    
                                    <!-- Rating Display -->
                                    <div class="mb-2">
                                        <div class="d-flex align-items-center">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="fas fa-star @(i <= review.Rating ? "text-warning" : "text-muted")"></i>
                                            }
                                            <span class="ms-2 fw-bold">@review.Rating/5</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Comment -->
                                    <p class="text-muted mb-2">
                                        @if (review.Comment.Length > 150)
                                        {
                                            <span>@review.Comment.Substring(0, 150)...</span>
                                            <a href="#" class="read-more" data-full-text="@review.Comment">Xem thêm</a>
                                        }
                                        else
                                        {
                                            @review.Comment
                                        }
                                    </p>
                                    
                                    @if (review.UpdatedAt.HasValue && review.UpdatedAt > review.CreatedAt)
                                    {
                                        <small class="text-muted">
                                            <i class="fas fa-edit me-1"></i>Đã chỉnh sửa: @review.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    }
                                </div>
                                
                                <!-- Actions -->
                                <div class="col-md-2 text-end">
                                    @if (review.CanEdit)
                                    {
                                        <div class="btn-group-vertical" role="group">
                                            <a asp-action="Edit" asp-route-id="@review.Id" 
                                               class="btn btn-sm btn-outline-warning mb-1">
                                                <i class="fas fa-edit me-1"></i>Sửa
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger delete-review" 
                                                    data-review-id="@review.Id"
                                                    data-book-title="@review.BookTitle">
                                                <i class="fas fa-trash me-1"></i>Xóa
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Xác nhận xóa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa đánh giá cho sách <strong id="book-title"></strong> không?</p>
                <p class="text-muted">Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">
                    <i class="fas fa-trash me-1"></i>Xóa đánh giá
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let reviewToDelete = null;

            // Delete review handler
            $('.delete-review').on('click', function() {
                reviewToDelete = $(this).data('review-id');
                const bookTitle = $(this).data('book-title');
                $('#book-title').text(bookTitle);
                $('#deleteModal').modal('show');
            });

            // Confirm delete
            $('#confirm-delete').on('click', function() {
                if (reviewToDelete) {
                    const token = $('input[name="__RequestVerificationToken"]').val();
                    
                    $.ajax({
                        url: '@Url.Action("Delete", "Review")',
                        type: 'POST',
                        data: {
                            id: reviewToDelete,
                            __RequestVerificationToken: token
                        },
                        success: function(response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                alert('Có lỗi xảy ra: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('Có lỗi xảy ra khi xóa đánh giá.');
                        },
                        complete: function() {
                            $('#deleteModal').modal('hide');
                            reviewToDelete = null;
                        }
                    });
                }
            });

            // Read more functionality
            $('.read-more').on('click', function(e) {
                e.preventDefault();
                const fullText = $(this).data('full-text');
                const parent = $(this).parent();
                parent.html(fullText);
            });
        });
    </script>

    <style>
        .review-card {
            transition: box-shadow 0.2s ease;
            border: 1px solid #e9ecef;
        }

        .review-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }

        .empty-state {
            max-width: 400px;
            margin: 0 auto;
        }

        .btn-group-vertical .btn {
            border-radius: 0.375rem !important;
        }

        .read-more {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }

        .read-more:hover {
            text-decoration: underline;
        }

        .star {
            font-size: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn-sm {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        h5 a {
            color: #333;
        }

        h5 a:hover {
            color: #007bff;
        }
    </style>

    @Html.AntiForgeryToken()
}