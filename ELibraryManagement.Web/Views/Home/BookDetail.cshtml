@using ELibraryManagement.Web.Models
@model BookViewModel
@{
    ViewData["Title"] = $"{Model.Title} - Chi Ti·∫øt S√°ch";
}

@section Styles {
    <link rel="stylesheet" href="~/css/book-detail.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="breadcrumb-nav">
    <div class="container">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "Home")">
                    <i class="fas fa-home me-1"></i>Trang Ch·ªß
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="@Url.Action("Books", "Home")">
                    <i class="fas fa-book me-1"></i>Danh S√°ch S√°ch
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
        </ol>
    </div>
</nav>

<!-- Main Book Detail Section -->
<div class="container book-detail-container">
    <div class="row">
        <!-- Book Image and Quick Actions -->
        <div class="col-lg-5 mb-4">
            <div class="book-image-section">
                <div class="book-cover-wrapper">
                    <img src="@Model.ImageUrl" alt="@Model.Title" class="book-cover"
                        onerror="this.src='/images/default-book-cover.jpg'">
                    <div class="book-badge">
                        @if (Model.AvailableCopies > 0)
                        {
                            <span class="badge-available">üìö C√≥ S·∫µn</span>
                        }
                        else
                        {
                            <span class="badge-unavailable">‚ùå H·∫øt S√°ch</span>
                        }
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions mt-4">
                    @if (Model.AvailableCopies > 0)
                    {
                        <button class="btn btn-borrow btn-lg w-100 mb-3" onclick="borrowBook(@Model.Id)">
                            <i class="fas fa-book-reader me-2"></i>
                            M∆∞·ª£n S√°ch Ngay
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-unavailable btn-lg w-100 mb-3" disabled>
                            <i class="fas fa-clock me-2"></i>
                            ƒê·∫∑t H√†ng Ch·ªù
                        </button>
                    }

                    <div class="row">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="addToWishlist(@Model.Id)">
                                <i class="fas fa-heart me-1"></i>Y√™u Th√≠ch
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-secondary w-100" onclick="shareBook(@Model.Id)">
                                <i class="fas fa-share-alt me-1"></i>Chia S·∫ª
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Book Stats -->
                <div class="book-stats mt-4">
                    <div class="stat-item">
                        <div class="stat-label">ƒê√°nh Gi√°</div>
                        <div class="stat-value">
                            <div class="rating-display">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Model.AverageRating)
                                    {
                                        <i class="fas fa-star text-warning"></i>
                                    }
                                    else if (i - 0.5 <= (double)Model.AverageRating)
                                    {
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                    }
                                    else
                                    {
                                        <i class="far fa-star text-muted"></i>
                                    }
                                }
                                <span class="rating-text ms-2">@Model.AverageRating.ToString("F1")/5.0</span>
                            </div>
                            <small class="text-muted">(@Model.RatingCount l∆∞·ª£t ƒë√°nh gi√°)</small>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">T√¨nh Tr·∫°ng</div>
                        <div class="stat-value">
                            <span class="available-info">
                                @Model.AvailableCopies/@Model.TotalCopies cu·ªën c√≥ s·∫µn
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Book Information -->
        <div class="col-lg-7">
            <div class="book-info-section">
                <div class="book-header">
                    <h1 class="book-title">@Model.Title</h1>
                    <p class="book-author">
                        <i class="fas fa-user-edit me-2 text-primary"></i>
                        T√°c gi·∫£: <strong>@Model.Author</strong>
                    </p>

                    <div class="book-price">
                        <span class="price-label">Tr·∫°ng th√°i:</span>
                        <span class="price-value text-success">Mi·ªÖn ph√≠ m∆∞·ª£n</span>
                    </div>
                </div>

                <!-- Book Description -->
                <div class="book-description">
                    <h5 class="section-title">üìñ M√¥ T·∫£ S√°ch</h5>
                    <p class="description-text">@Model.Description</p>
                </div>

                <!-- Book Details -->
                <div class="book-details">
                    <h5 class="section-title">üìã Th√¥ng Tin Chi Ti·∫øt</h5>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">üìö Th·ªÉ Lo·∫°i:</span>
                            <span class="detail-value">@Model.CategoryName</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üè¢ Nh√† Xu·∫•t B·∫£n:</span>
                            <span class="detail-value">@Model.Publisher</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìÖ NƒÉm Xu·∫•t B·∫£n:</span>
                            <span class="detail-value">@Model.PublicationYear</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üî¢ M√£ ISBN:</span>
                            <span class="detail-value isbn-value" title="@Model.ISBN">@Model.ISBN</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üåê Ng√¥n Ng·ªØ:</span>
                            <span class="detail-value">@Model.Language</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìÑ S·ªë Trang:</span>
                            <span class="detail-value">@Model.PageCount trang</span>
                        </div>
                    </div>
                </div>

                <!-- Borrowing Information -->
                <div class="borrowing-info">
                    <h5 class="section-title">‚ÑπÔ∏è Quy ƒê·ªãnh M∆∞·ª£n S√°ch Th∆∞ Vi·ªán</h5>
                    <div class="info-list">
                        <div class="info-section">
                            <h6 class="info-section-title">
                                <i class="fas fa-clock text-primary me-2"></i>
                                Th·ªùi Gian M∆∞·ª£n S√°ch
                            </h6>
                            <div class="info-item">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <span>Th·ªùi gian m∆∞·ª£n t·ªëi ƒëa: <strong>14 ng√†y</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-redo text-success me-2"></i>
                                <span>C√≥ th·ªÉ gia h·∫°n: <strong>1 l·∫ßn (7 ng√†y)</strong> n·∫øu kh√¥ng c√≥ ng∆∞·ªùi ƒë·∫∑t
                                    tr∆∞·ªõc</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-users text-info me-2"></i>
                                <span>S·ªë s√°ch ƒë∆∞·ª£c m∆∞·ª£n t·ªëi ƒëa: <strong>5 cu·ªën/sinh vi√™n</strong></span>
                            </div>
                        </div>

                        <div class="info-section">
                            <h6 class="info-section-title">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                Ch·∫ø T√†i Vi Ph·∫°m
                            </h6>
                            <div class="info-item warning">
                                <i class="fas fa-money-bill-wave text-warning me-2"></i>
                                <span>Ph√≠ ph·∫°t qu√° h·∫°n: <strong>5,000ƒë/ng√†y/cu·ªën</strong></span>
                            </div>
                            <div class="info-item warning">
                                <i class="fas fa-ban text-danger me-2"></i>
                                <span>Qu√° h·∫°n tr√™n 30 ng√†y: <strong>Kh√≥a t√†i kho·∫£n th∆∞ vi·ªán</strong></span>
                            </div>
                            <div class="info-item warning">
                                <i class="fas fa-graduation-cap text-danger me-2"></i>
                                <span>N·ª£ s√°ch khi t·ªët nghi·ªáp: <strong>Kh√¥ng ƒë∆∞·ª£c c·∫•p b·∫±ng</strong></span>
                            </div>
                            <div class="info-item warning">
                                <i class="fas fa-file-contract text-danger me-2"></i>
                                <span>N·ª£ ph√≠ ph·∫°t tr√™n 100,000ƒë: <strong>Kh√≥a t√†i kho·∫£n ƒëƒÉng k√Ω h·ªçc ph·∫ßn</strong></span>
                            </div>
                        </div>

                        <div class="info-section">
                            <h6 class="info-section-title">
                                <i class="fas fa-shield-alt text-info me-2"></i>
                                B·ªìi Th∆∞·ªùng & B·∫£o Hi·ªÉm
                            </h6>
                            <div class="info-item">
                                <i class="fas fa-book-dead text-danger me-2"></i>
                                <span>M·∫•t s√°ch: <strong>B·ªìi th∆∞·ªùng 120% gi√° tr·ªã ho·∫∑c mua s√°ch m·ªõi c√πng
                                        lo·∫°i</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-cut text-warning me-2"></i>
                                <span>H∆∞ h·ªèng s√°ch: <strong>B·ªìi th∆∞·ªùng 50-100% t√πy m·ª©c ƒë·ªô</strong></span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-water text-primary me-2"></i>
                                <span>∆Ø·ªõt, r√°ch, vi·∫øt v·∫Ω: <strong>Ph·∫°t 20,000-50,000ƒë</strong></span>
                            </div>
                        </div>

                        <div class="info-section">
                            <h6 class="info-section-title">
                                <i class="fas fa-info-circle text-success me-2"></i>
                                L∆∞u √ù Quan Tr·ªçng
                            </h6>
                            <div class="info-item">
                                <i class="fas fa-id-card text-success me-2"></i>
                                <span>C·∫ßn th·∫ª sinh vi√™n c√≥ hi·ªáu l·ª±c ƒë·ªÉ m∆∞·ª£n s√°ch</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-bell text-info me-2"></i>
                                <span>Nh·∫≠n th√¥ng b√°o nh·∫Øc nh·ªü qua email tr∆∞·ªõc 3 ng√†y h·∫øt h·∫°n</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-mobile-alt text-primary me-2"></i>
                                <span>C√≥ th·ªÉ gia h·∫°n online qua website ho·∫∑c app mobile</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-question-circle text-secondary me-2"></i>
                                <span>Li√™n h·ªá th·ªß th∆∞: <strong>library@university.edu.vn</strong> ho·∫∑c <strong>(024)
                                        3869-xxxx</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Related Books Section -->
@if (ViewBag.RelatedBooks != null && ((List<BookViewModel>)ViewBag.RelatedBooks).Any())
{
    <div class="related-books-section">
        <div class="container">
            <h3 class="section-title text-center mb-5">
                <i class="fas fa-books me-2"></i>
                S√°ch C√πng Th·ªÉ Lo·∫°i
            </h3>
            <div class="row">
                @foreach (var book in (List<BookViewModel>)ViewBag.RelatedBooks)
                {
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="related-book-card">
                            <div class="book-image">
                                <img src="@book.ImageUrl" alt="@book.Title" onerror="this.src='/images/default-book-cover.jpg'">
                                <div class="book-overlay">
                                    <a href="@Url.Action("BookDetail", new { id = book.Id })"
                                        class="btn btn-outline-white btn-sm">
                                        <i class="fas fa-eye me-1"></i>Xem Chi Ti·∫øt
                                    </a>
                                </div>
                            </div>
                            <div class="book-content">
                                <h6 class="book-title">@book.Title</h6>
                                <p class="book-author">@book.Author</p>
                                <div class="book-rating">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= book.AverageRating)
                                        {
                                            <i class="fas fa-star text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star text-muted"></i>
                                        }
                                    }
                                </div>
                                <div class="book-price">
                                    <span class="text-success">Mi·ªÖn ph√≠</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Borrow book function
        function borrowBook(bookId) {
            console.log('borrowBook called with bookId:', bookId);
            console.log('isUserLoggedIn:', isUserLoggedIn());

            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!isUserLoggedIn()) {
                console.log('User not logged in, showing login dialog');
                Swal.fire({
                    title: 'üîê C·∫ßn ƒêƒÉng Nh·∫≠p',
                    text: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ m∆∞·ª£n s√°ch. Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#da251e',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ƒêƒÉng Nh·∫≠p',
                    cancelButtonText: 'H·ªßy',
                    customClass: {
                        popup: 'swal-vietnamese'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/Account/Login';
                    }
                });
                return;
            }

            console.log('User is logged in, showing confirm dialog');
            // Confirm borrow
            Swal.fire({
                title: 'üìö X√°c Nh·∫≠n M∆∞·ª£n S√°ch',
                text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m∆∞·ª£n s√°ch "${@Html.Raw(Json.Serialize(Model.Title))}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#da251e',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'M∆∞·ª£n Ngay',
                cancelButtonText: 'H·ªßy',
                customClass: {
                    popup: 'swal-vietnamese'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'ƒêang x·ª≠ l√Ω...',
                        text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Redirect to Book/Borrow page
                    setTimeout(() => {
                        window.location.href = `/Book/Borrow/${bookId}`;
                    }, 500);
                }
            });
        }

        // Add to wishlist function
        function addToWishlist(bookId) {
            Swal.fire({
                title: 'üíù Th√™m V√†o Y√™u Th√≠ch',
                text: 'T√≠nh nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn trong phi√™n b·∫£n ti·∫øp theo!',
                icon: 'info',
                confirmButtonColor: '#da251e'
            });
        }

        // Share book function
        function shareBook(bookId) {
            const bookUrl = window.location.href;
            const bookTitle = @Html.Raw(Json.Serialize(Model.Title));

            if (navigator.share) {
                navigator.share({
                    title: bookTitle,
                    text: `T√¥i v·ª´a t√¨m th·∫•y cu·ªën s√°ch hay: ${bookTitle}`,
                    url: bookUrl
                }).catch(console.error);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(bookUrl).then(() => {
                    Swal.fire({
                        title: 'üìã ƒê√£ Sao Ch√©p',
                        text: 'Link s√°ch ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o clipboard!',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }
        }

        // Check if user is logged in
        function isUserLoggedIn() {
            // Use server-side authentication check
            return @Html.Raw(Json.Serialize(ViewBag.IsAuthenticated ?? false));
        }

        // Get auth token
        function getAuthToken() {
            return @Html.Raw(Json.Serialize(ViewBag.AuthToken ?? ""));
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            // Add smooth scrolling to related books
            const relatedBooksCards = document.querySelectorAll('.related-book-card');
            relatedBooksCards.forEach(card => {
                card.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-5px)';
                });
                card.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateY(0)';
                });
            });

            // Book cover animation
            const bookCover = document.querySelector('.book-cover');
            bookCover.addEventListener('mouseenter', function () {
                this.style.transform = 'scale(1.05) rotateY(5deg)';
            });
            bookCover.addEventListener('mouseleave', function () {
                this.style.transform = 'scale(1) rotateY(0deg)';
            });
        });
    </script>

    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
}