@model List<ELibraryManagement.Web.Models.FineViewModel>
@using ELibraryManagement.Web.Models
@{
    ViewData["Title"] = "Quản lý phạt";
    Layout = "_AdminLayout";
    var statistics = ViewBag.Statistics as ELibraryManagement.Web.Models.FineStatisticsViewModel;
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var totalPages = ViewBag.TotalPages as int? ?? 1;
    var totalCount = ViewBag.TotalCount as int? ?? 0;
    var currentStatus = ViewBag.CurrentStatus as string;
    var currentSearch = ViewBag.CurrentSearch as string;
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-money-bill-wave"></i>
            Quản lý phạt
        </h1>
        @* Disabled Create Fine Feature *@
        @* <a href="@Url.Action("CreateFine")" class="btn btn-primary shadow-sm">
            <i class="fas fa-plus"></i>
            Tạo phạt mới
        </a> *@
    </div>

    <!-- Statistics Cards -->
    @if (statistics != null)
    {
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Tổng số phạt</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.TotalFines</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-list fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Chờ thanh toán</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.PendingFines</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Đã thanh toán</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.PaidFines</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-danger shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Quá hạn</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.OverdueFines</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Amount Statistics -->
        <div class="row mb-4">
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tổng tiền phạt</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.TotalAmount.ToString("N0") VND</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-money-bill fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Đã thu</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.PaidAmount.ToString("N0") VND</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-coins fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Chưa thu</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.PendingAmount.ToString("N0") VND</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-hand-holding-usd fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Search and Filter -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Tìm kiếm và lọc</h6>
        </div>
        <div class="card-body">
            <form method="get" action="@Url.Action("Fines")">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="status">Trạng thái</label>
                            <select name="status" id="status" class="form-control">
                                <option value="">Tất cả</option>
                                @foreach (var status in FineStatuses.GetDisplayNames())
                                {
                                    <option value="@status.Key" selected="@(currentStatus == status.Key)">
                                        @status.Value
                                    </option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="search">Tìm kiếm theo tên hoặc email</label>
                            <input type="text" name="search" id="search" class="form-control" 
                                   value="@currentSearch" placeholder="Nhập tên hoặc email sinh viên...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary mr-2">
                                    <i class="fas fa-search"></i> Tìm
                                </button>
                                <a href="@Url.Action("Fines")" class="btn btn-secondary">
                                    <i class="fas fa-redo"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Fines Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                Danh sách phạt (@totalCount kết quả)
            </h6>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered" id="finesTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sinh viên</th>
                                <th>Sách</th>
                                <th>Số tiền</th>
                                <th>Lý do</th>
                                <th>Trạng thái</th>
                                <th>Ngày tạo</th>
                                <th>Hạn thanh toán</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var fine in Model)
                            {
                                <tr class="@(fine.IsOverdue ? "table-danger" : "")">
                                    <td>#@fine.Id</td>
                                    <td>
                                        <div>
                                            <strong>@fine.UserFullName</strong>
                                        </div>
                                        <small class="text-muted">@fine.UserEmail</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(fine.BookTitle))
                                        {
                                            <span class="text-primary">@fine.BookTitle</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Không liên quan đến sách</span>
                                        }
                                    </td>
                                    <td>
                                        <strong class="text-danger">@fine.Amount.ToString("N0") VND</strong>
                                    </td>
                                    <td>
                                        <span title="@fine.Description">@fine.Reason</span>
                                    </td>
                                    <td>
                                        @{
                                            var statusClass = fine.Status switch
                                            {
                                                // Use Bootstrap 5 background and text classes for good contrast
                                                "Pending" => fine.IsOverdue ? "bg-danger text-white" : "bg-warning text-dark",
                                                "Paid" => "bg-success text-white",
                                                "Waived" => "bg-info text-dark",
                                                _ => "bg-secondary text-white"
                                            };
                                        }
                                        <span class="badge @statusClass" style="font-size:0.9rem;">
                                            @FineStatuses.GetDisplayName(fine.Status)
                                        </span>
                                        @if (fine.IsOverdue)
                                        {
                                            <br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Quá hạn</small>
                                        }
                                    </td>
                                    <td>
                                        <small>@fine.FineDate.ToString("dd/MM/yyyy")</small>
                                    </td>
                                    <td>
                                        @if (fine.DueDate.HasValue)
                                        {
                                            <small class="@(fine.IsOverdue ? "text-danger" : "")">
                                                @fine.DueDate.Value.ToString("dd/MM/yyyy")
                                            </small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">Không giới hạn</small>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical" role="group">
                                            <button type="button" class="btn btn-sm btn-info mb-1" 
                                                    onclick="viewFineDetails(@fine.Id)" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            @if (fine.Status == "Pending")
                                            {
                                                <button type="button" class="btn btn-sm btn-success mb-1" 
                                                        onclick="markAsPaid(@fine.Id, '@fine.UserFullName')" title="Đánh dấu đã thanh toán">
                                                    <i class="fas fa-money-bill"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <nav aria-label="Fine pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Fines", new { page = currentPage - 1, status = currentStatus, search = currentSearch })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>

                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Fines", new { page = i, status = currentStatus, search = currentSearch })">@i</a>
                                </li>
                            }

                            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Fines", new { page = currentPage + 1, status = currentStatus, search = currentSearch })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                    <p class="text-muted">Không có phạt nào được tìm thấy</p>
                    @* Disabled Create Fine Feature *@
                    @* <a href="@Url.Action("CreateFine")" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Tạo phạt mới
                    </a> *@
                </div>
            }
        </div>
    </div>
</div>

<!-- Fine Detail Modal -->
<div class="modal fade" id="fineDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <!-- Content will be loaded via AJAX -->
        </div>
    </div>
</div>

<!-- Pay Fine Modal -->
<div class="modal fade" id="payFineModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận thanh toán phạt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn đánh dấu phạt này là đã thanh toán?</p>
                <div class="form-group">
                    <label for="paymentNotes">Ghi chú thanh toán</label>
                    <textarea id="paymentNotes" class="form-control" rows="3" placeholder="Nhập ghi chú về việc thanh toán..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" onclick="confirmPayment()">Xác nhận thanh toán</button>
            </div>
        </div>
    </div>
</div>

<!-- Waive Fine Modal -->
<div class="modal fade" id="waiveFineModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Miễn phạt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn miễn phạt này?</p>
                <div class="form-group">
                    <label for="waiveReason">Lý do miễn phạt <span class="text-danger">*</span></label>
                    <input type="text" id="waiveReason" class="form-control" placeholder="Nhập lý do miễn phạt..." required>
                </div>
                <div class="form-group">
                    <label for="waiveNotes">Ghi chú</label>
                    <textarea id="waiveNotes" class="form-control" rows="3" placeholder="Nhập ghi chú thêm..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="confirmWaive()">Xác nhận miễn phạt</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentFineId = 0;

        function viewFineDetails(fineId) {
            console.log('Trying to view fine details for ID:', fineId);
            
            $.get('@Url.Action("FineDetails")/' + fineId, function(data) {
                console.log('Fine details loaded successfully');
                $('#fineDetailModal .modal-content').html(data);
                $('#fineDetailModal').modal('show');
            }).fail(function(xhr, status, error) {
                console.error('Failed to load fine details:', xhr.status, error);
                console.error('Response:', xhr.responseText);
                showNotification('Không thể tải chi tiết phạt: ' + (xhr.responseText || error), 'error');
            });
        }

        function markAsPaid(fineId, userName) {
            currentFineId = fineId;
            $('#payFineModal .modal-body p').html(`Bạn có chắc chắn muốn đánh dấu phạt của sinh viên <strong>${userName}</strong> là đã thanh toán?`);
            $('#paymentNotes').val('');
            $('#payFineModal').modal('show');
        }

        function waiveFine(fineId, userName, amount) {
            currentFineId = fineId;
            $('#waiveFineModal .modal-body p').html(`Bạn có chắc chắn muốn miễn phạt <strong>${amount.toLocaleString()} VND</strong> của sinh viên <strong>${userName}</strong>?`);
            $('#waiveReason').val('');
            $('#waiveNotes').val('');
            $('#waiveFineModal').modal('show');
        }

        function confirmPayment() {
            const notes = $('#paymentNotes').val();
            
            $.post('@Url.Action("MarkFineAsPaid")', {
                id: currentFineId,
                notes: notes
            }, function(response) {
                if (response.success) {
                    // use centralized notification (renders at top-right)
                    showNotification(response.message, 'success');
                    $('#payFineModal').modal('hide');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(response.message, 'error');
                }
                }).fail(function() {
                showNotification('Có lỗi xảy ra khi cập nhật trạng thái phạt', 'error');
            });
        }

        function confirmWaive() {
            const reason = $('#waiveReason').val().trim();
            const notes = $('#waiveNotes').val();
            
                if (!reason) {
                showNotification('Vui lòng nhập lý do miễn phạt', 'warning');
                return;
            }

            $.post('@Url.Action("WaiveFine")', {
                id: currentFineId,
                reason: reason,
                notes: notes
            }, function(response) {
                if (response.success) {
                    showNotification(response.message, 'success');
                    $('#waiveFineModal').modal('hide');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(response.message, 'error');
                }
            }).fail(function() {
                showAlert('danger', 'Có lỗi xảy ra khi miễn phạt');
            });
        }

        // Use the centralized showNotification defined in /wwwroot/js/admin.js
        // showNotification(message, type) -> positions to top-right

        // Initialize DataTable for better UX
        $(document).ready(function() {
            if ($('#finesTable tbody tr').length > 0) {
                $('#finesTable').DataTable({
                    "paging": false,
                    "searching": false,
                    "ordering": true,
                    "info": false,
                    "language": {
                        "emptyTable": "Không có dữ liệu",
                        "zeroRecords": "Không tìm thấy kết quả phù hợp"
                    }
                });
            }
        });
    </script>
}
