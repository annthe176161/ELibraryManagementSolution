@model ResetPasswordViewModel
@{
    ViewData["Title"] = "Đặt lại mật khẩu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lock-open me-2"></i>
                        Đặt lại mật khẩu
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Nhập mật khẩu mới cho tài khoản của bạn.
                    </p>

                    <form asp-action="ResetPassword" method="post" id="resetPasswordForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <input asp-for="Email" type="hidden" />
                        <input asp-for="Token" type="hidden" />

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-envelope me-1"></i>
                                Email
                            </label>
                            <input value="@Model.Email" class="form-control" readonly />
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewPassword" class="form-label">
                                <i class="fas fa-key me-1"></i>
                                Mật khẩu mới
                            </label>
                            <div class="input-group">
                                <input asp-for="NewPassword" class="form-control" type="password" id="newPassword" placeholder="Nhập mật khẩu mới" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                            
                            <!-- Password Strength Indicator -->
                            <div class="mt-2">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="passwordStrengthText">Độ mạnh mật khẩu</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">
                                <i class="fas fa-check-double me-1"></i>
                                Xác nhận mật khẩu mới
                            </label>
                            <div class="input-group">
                                <input asp-for="ConfirmPassword" class="form-control" type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu mới" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="fas fa-save me-2"></i>
                                Đặt lại mật khẩu
                            </button>
                        </div>

                        <div class="text-center">
                            <a asp-action="Login" class="text-decoration-none">
                                <i class="fas fa-arrow-left me-1"></i>
                                Quay lại đăng nhập
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Success/Error Messages -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // Toggle password visibility
            $('#toggleNewPassword').click(function() {
                var passwordField = $('#newPassword');
                var type = passwordField.attr('type') === 'password' ? 'text' : 'password';
                passwordField.attr('type', type);
                $(this).find('i').toggleClass('fa-eye fa-eye-slash');
            });

            $('#toggleConfirmPassword').click(function() {
                var passwordField = $('#confirmPassword');
                var type = passwordField.attr('type') === 'password' ? 'text' : 'password';
                passwordField.attr('type', type);
                $(this).find('i').toggleClass('fa-eye fa-eye-slash');
            });

            // Password strength checker
            $('#newPassword').on('input', function() {
                var password = $(this).val();
                var strength = checkPasswordStrength(password);
                updatePasswordStrengthUI(strength);
            });

            function checkPasswordStrength(password) {
                var score = 0;
                var strength = {
                    score: 0,
                    text: 'Rất yếu',
                    class: 'bg-danger'
                };

                if (password.length >= 8) score += 25;
                if (/[a-z]/.test(password)) score += 25;
                if (/[A-Z]/.test(password)) score += 25;
                if (/[0-9]/.test(password)) score += 25;
                if (/[^A-Za-z0-9]/.test(password)) score += 25;

                strength.score = Math.min(score, 100);

                if (strength.score >= 100) {
                    strength.text = 'Rất mạnh';
                    strength.class = 'bg-success';
                } else if (strength.score >= 75) {
                    strength.text = 'Mạnh';
                    strength.class = 'bg-info';
                } else if (strength.score >= 50) {
                    strength.text = 'Trung bình';
                    strength.class = 'bg-warning';
                } else if (strength.score >= 25) {
                    strength.text = 'Yếu';
                    strength.class = 'bg-warning';
                }

                return strength;
            }

            function updatePasswordStrengthUI(strength) {
                $('#passwordStrength')
                    .removeClass('bg-danger bg-warning bg-info bg-success')
                    .addClass(strength.class)
                    .css('width', strength.score + '%');
                
                $('#passwordStrengthText').text(strength.text);
            }

            // Form submission
            $('#resetPasswordForm').on('submit', function() {
                var submitBtn = $('#submitBtn');
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');
            });

            // Auto-dismiss alerts after 10 seconds
            setTimeout(function() {
                $('.alert').alert('close');
            }, 10000);
        });
    </script>
}