@model ResetPasswordViewModel
@{
    ViewData["Title"] = "Đặt lại mật khẩu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="min-vh-100 d-flex align-items-center bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-5 col-md-7 col-sm-9">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-5">
                        <!-- Header -->
                        <div class="text-center mb-4">
                            <div class="mb-3">
                                <i class="fas fa-shield-alt text-success" style="font-size: 3rem;"></i>
                            </div>
                            <h2 class="h4 text-gray-900 mb-2">Đặt lại mật khẩu</h2>
                            <p class="text-muted small">
                                Tạo mật khẩu mới mạnh và an toàn cho tài khoản của bạn.
                            </p>
                        </div>

                        <!-- Form -->
                        <form asp-action="ResetPassword" method="post" id="resetPasswordForm">
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger d-none"></div>

                            <input asp-for="Email" type="hidden" />
                            <input asp-for="Token" type="hidden" />

                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-envelope text-muted me-2"></i>
                                    Email
                                </label>
                                <input value="@Model.Email" class="form-control form-control-lg bg-light" readonly />
                            </div>

                            <div class="form-group mb-3">
                                <label asp-for="NewPassword" class="form-label fw-semibold">
                                    <i class="fas fa-key text-muted me-2"></i>
                                    Mật khẩu mới
                                </label>
                                <div class="input-group">
                                    <input asp-for="NewPassword" class="form-control form-control-lg" type="password"
                                        id="newPassword" placeholder="Nhập mật khẩu mới" autocomplete="new-password" />
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="NewPassword" class="text-danger small"></span>

                                <!-- Password Strength Indicator -->
                                <div class="mt-2">
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar" id="passwordStrength" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="passwordStrengthText">Nhập mật khẩu để kiểm tra độ
                                        mạnh</small>
                                </div>
                            </div>

                            <div class="form-group mb-4">
                                <label asp-for="ConfirmPassword" class="form-label fw-semibold">
                                    <i class="fas fa-check-double text-muted me-2"></i>
                                    Xác nhận mật khẩu mới
                                </label>
                                <div class="input-group">
                                    <input asp-for="ConfirmPassword" class="form-control form-control-lg"
                                        type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu mới"
                                        autocomplete="new-password" />
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                            </div>

                            <div class="d-grid mb-4">
                                <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    <span id="submitText">Đặt lại mật khẩu</span>
                                </button>
                            </div>

                            <div class="text-center">
                                <a asp-action="Login" class="text-decoration-none fw-semibold">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Quay lại đăng nhập
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show mt-3 border-0 shadow-sm" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle text-success me-3" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>Thành công!</strong><br>
                                <span class="small">@TempData["SuccessMessage"]</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show mt-3 border-0 shadow-sm" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-danger me-3" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>Có lỗi xảy ra!</strong><br>
                                <span class="small">@TempData["ErrorMessage"]</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <!-- Password Requirements -->
                <div class="card border-0 mt-4 bg-light">
                    <div class="card-body p-4">
                        <h6 class="card-title text-muted mb-3">
                            <i class="fas fa-lock me-2"></i>
                            Yêu cầu mật khẩu
                        </h6>
                        <ul class="list-unstyled small text-muted mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Ít nhất 8 ký tự
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Chứa ít nhất 1 chữ hoa và 1 chữ thường
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Chứa ít nhất 1 số
                            </li>
                            <li>
                                <i class="fas fa-check text-success me-2"></i>
                                Chứa ít nhất 1 ký tự đặc biệt (@@#!%*?&)
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            // Toggle password visibility
            $('#toggleNewPassword').click(function () {
                var passwordField = $('#newPassword');
                var type = passwordField.attr('type') === 'password' ? 'text' : 'password';
                passwordField.attr('type', type);
                $(this).find('i').toggleClass('fa-eye fa-eye-slash');
            });

            $('#toggleConfirmPassword').click(function () {
                var passwordField = $('#confirmPassword');
                var type = passwordField.attr('type') === 'password' ? 'text' : 'password';
                passwordField.attr('type', type);
                $(this).find('i').toggleClass('fa-eye fa-eye-slash');
            });

            // Password strength checker
            $('#newPassword').on('input', function () {
                var password = $(this).val();
                var strength = checkPasswordStrength(password);
                updatePasswordStrengthUI(strength);
            });

            function checkPasswordStrength(password) {
                var score = 0;
                var strength = {
                    score: 0,
                    text: 'Rất yếu',
                    class: 'bg-danger'
                };

                if (password.length >= 8) score += 25;
                if (/[a-z]/.test(password)) score += 25;
                if (/[A-Z]/.test(password)) score += 25;
                if (/[0-9]/.test(password)) score += 25;
                if (/[^A-Za-z0-9]/.test(password)) score += 25;

                strength.score = Math.min(score, 100);

                if (strength.score >= 100) {
                    strength.text = 'Rất mạnh';
                    strength.class = 'bg-success';
                } else if (strength.score >= 75) {
                    strength.text = 'Mạnh';
                    strength.class = 'bg-info';
                } else if (strength.score >= 50) {
                    strength.text = 'Trung bình';
                    strength.class = 'bg-warning';
                } else if (strength.score >= 25) {
                    strength.text = 'Yếu';
                    strength.class = 'bg-warning';
                }

                return strength;
            }

            function updatePasswordStrengthUI(strength) {
                $('#passwordStrength')
                    .removeClass('bg-danger bg-warning bg-info bg-success')
                    .addClass(strength.class)
                    .css('width', strength.score + '%');

                $('#passwordStrengthText').text(strength.text);
            }

            // Form submission
            $('#resetPasswordForm').on('submit', function () {
                var submitBtn = $('#submitBtn');
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');
            });

            // Auto-dismiss alerts after 10 seconds
            setTimeout(function () {
                $('.alert').alert('close');
            }, 10000);
        });
    </script>
}