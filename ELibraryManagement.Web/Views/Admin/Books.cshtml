@model List<BookViewModel>

@{
    ViewData["Title"] = "Quản lý sách - E-Library";
    Layout = "_AdminLayout";
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h2 class="h3 mb-0">
                        <i class="fas fa-book me-2 text-success"></i>
                        Quản lý sách
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a asp-action="Index">Quản trị</a>
                            </li>
                            <li class="breadcrumb-item active">Sách</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bookModal" onclick="openCreateBookModal()">
                        <i class="fas fa-plus me-1"></i>
                        Thêm sách mới
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="small">Tổng số sách</div>
                            <div class="h4 mb-0">@Model.Count</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="small">Có sẵn</div>
                            <div class="h4 mb-0">@Model.Count(b => b.AvailableCopies > 0)</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="small">Đang được mượn</div>
                            <div class="h4 mb-0">@Model.Sum(b => b.TotalCopies - b.AvailableCopies)</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hand-holding fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="small">Hết sách</div>
                            <div class="h4 mb-0">@Model.Count(b => b.AvailableCopies == 0)</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Books Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">Danh sách sách</h5>
                        <div class="d-flex">
                            <div class="input-group input-group-sm me-3" style="width: 300px;">
                                <input type="text" class="form-control" placeholder="Tìm kiếm sách..." id="searchInput">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <select class="form-select form-select-sm" id="statusFilter" style="width: 150px;">
                                <option value="">Tất cả trạng thái</option>
                                <option value="available">Có sẵn</option>
                                <option value="borrowed">Đang mượn</option>
                                <option value="outofstock">Hết sách</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="booksTable">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Sách</th>
                                    <th scope="col">Tác giả</th>
                                    <th scope="col">Thể loại</th>
                                    <th scope="col">ISBN</th>
                                    <th scope="col">Tình trạng</th>
                                    <th scope="col">Số lượng</th>
                                    <th scope="col">Đánh giá</th>
                                    <th scope="col">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var book in Model)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@book.ImageUrl" alt="@book.Title" 
                                                     class="me-3 rounded" 
                                                     style="width: 60px; height: 80px; object-fit: cover;">
                                                <div>
                                                    <h6 class="mb-1">@book.Title</h6>
                                                    <small class="text-muted">@(string.IsNullOrEmpty(book.Description) ? "" : (book.Description.Length > 50 ? book.Description.Substring(0, 50) + "..." : book.Description))</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@book.Author</td>
                                        <td>
                                            <span class="badge bg-primary">@book.CategoryName</span>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(book.ISBN))
                                            {
                                                <code>@book.ISBN</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                        </td>
                                        <td>
                                            @if (book.AvailableCopies > 0)
                                            {
                                                <span class="badge bg-success">Có sẵn</span>
                                            }
                                            else if (book.TotalCopies > 0)
                                            {
                                                <span class="badge bg-warning">Đang mượn</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Hết sách</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <small><strong>Có sẵn:</strong> @book.AvailableCopies</small>
                                                <small><strong>Tổng:</strong> @book.TotalCopies</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="me-2">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        @if (i <= Math.Floor(book.AverageRating))
                                                        {
                                                            <i class="fas fa-star text-warning"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="far fa-star text-muted"></i>
                                                        }
                                                    }
                                                </div>
                                                <small class="text-muted">(@book.RatingCount)</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" title="Xem chi tiết" onclick="viewBook(@book.Id)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning" title="Chỉnh sửa" onclick="editBook(@book.Id)" data-bs-toggle="modal" data-bs-target="#bookModal">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" title="Xóa" onclick="deleteBook(@book.Id, '@book.Title')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Hiển thị @Model.Count sách
                        </small>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <span class="page-link">Trước</span>
                                </li>
                                <li class="page-item active">
                                    <span class="page-link">1</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">Sau</span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Book Modal (Create/Edit) -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalLabel">Thêm sách mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId" name="id" />
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="author" class="form-label">Tác giả <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="author" name="author" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="isbn" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="isbn" name="isbn">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="publisher" class="form-label">Nhà xuất bản</label>
                                <input type="text" class="form-control" id="publisher" name="publisher">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="publicationYear" class="form-label">Năm xuất bản</label>
                                <input type="number" class="form-control" id="publicationYear" name="publicationYear" 
                                       min="1000" max="2100" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Số lượng <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" 
                                       min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="pageCount" class="form-label">Số trang</label>
                                <input type="number" class="form-control" id="pageCount" name="pageCount" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="language" class="form-label">Ngôn ngữ</label>
                                <input type="text" class="form-control" id="language" name="language" value="Tiếng Việt">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categories" class="form-label">Danh mục</label>
                                <select class="form-select" id="categories" name="categoryIds" multiple>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                                <small class="form-text text-muted">Giữ Ctrl để chọn nhiều danh mục</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="coverImageUrl" class="form-label">URL hình bìa</label>
                        <input type="url" class="form-control" id="coverImageUrl" name="coverImageUrl" 
                               placeholder="https://example.com/image.jpg">
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveBookBtn" onclick="saveBook()">
                    <i class="fas fa-save me-1"></i>
                    Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa sách này không?</p>
                <div id="deleteDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentBookId = null;
        let categories = [];

        $(document).ready(function() {
            // Load categories for the form
            loadCategories();

            // Search functionality
            $('#searchInput').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#booksTable tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Status filter
            $('#statusFilter').on('change', function() {
                var value = $(this).val();
                $('#booksTable tbody tr').filter(function() {
                    if (value === '') {
                        $(this).show();
                    } else {
                        var statusText = $(this).find('td:nth-child(5) .badge').text().toLowerCase();
                        if (value === 'available') {
                            $(this).toggle(statusText.indexOf('có sẵn') > -1);
                        } else if (value === 'borrowed') {
                            $(this).toggle(statusText.indexOf('đang mượn') > -1);
                        } else if (value === 'outofstock') {
                            $(this).toggle(statusText.indexOf('hết sách') > -1);
                        }
                    }
                });
            });
        });

        // Load categories for dropdown
        function loadCategories() {
            $.get('/Admin/GetCategories')
                .done(function(response) {
                    if (response.success) {
                        categories = response.data;
                        updateCategoriesDropdown();
                    }
                })
                .fail(function() {
                    console.error('Failed to load categories');
                });
        }

        function updateCategoriesDropdown() {
            const select = $('#categories');
            select.empty();
            categories.forEach(category => {
                select.append(`<option value="${category.id}">${category.name}</option>`);
            });
        }

        // Open modal for creating new book
        function openCreateBookModal() {
            currentBookId = null;
            $('#bookModalLabel').text('Thêm sách mới');
            $('#bookForm')[0].reset();
            $('#bookId').val('');
            $('#publicationYear').val(new Date().getFullYear());
            $('#language').val('Tiếng Việt');
            $('#categories').val([]);
        }

        // View book details
        function viewBook(bookId) {
            // Implement view book functionality
            console.log('View book:', bookId);
            // You could redirect to a detail page or show a modal with book details
        }

        // Edit book
        function editBook(bookId) {
            currentBookId = bookId;
            $('#bookModalLabel').text('Chỉnh sửa sách');
            
            // Find book data from the table
            const row = $(`button[onclick="editBook(${bookId})"]`).closest('tr');
            const title = row.find('td:eq(0) h6').text().trim();
            const author = row.find('td:eq(1)').text().trim();
            
            // Load book details and populate form
            loadBookForEdit(bookId);
        }

        // Load book details for editing
        function loadBookForEdit(bookId) {
            // You might want to make an API call to get full book details
            // For now, we'll populate basic fields from the table
            const row = $(`button[onclick="editBook(${bookId})"]`).closest('tr');
            
            $('#bookId').val(bookId);
            $('#title').val(row.find('td:eq(0) h6').text().trim());
            $('#author').val(row.find('td:eq(1)').text().trim());
            
            // You would need to make an API call to get full book details
            // including ISBN, description, etc.
        }

        // Save book (create or update)
        function saveBook() {
            const form = $('#bookForm')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = {
                id: parseInt($('#bookId').val()) || 0,
                title: $('#title').val(),
                author: $('#author').val(),
                isbn: $('#isbn').val(),
                publisher: $('#publisher').val(),
                publicationYear: parseInt($('#publicationYear').val()),
                description: $('#description').val(),
                coverImageUrl: $('#coverImageUrl').val(),
                quantity: parseInt($('#quantity').val()),
                language: $('#language').val(),
                pageCount: parseInt($('#pageCount').val()) || 0,
                categoryIds: $('#categories').val() ? $('#categories').val().map(id => parseInt(id)) : []
            };

            const isEdit = currentBookId !== null && currentBookId > 0;
            const url = isEdit ? '/Admin/UpdateBook' : '/Admin/CreateBook';
            
            $('#saveBookBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        $('#bookModal').modal('hide');
                        alert(response.message);
                        location.reload(); // Reload page to show updated data
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr);
                    alert('Có lỗi xảy ra khi lưu sách');
                },
                complete: function() {
                    $('#saveBookBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i>Lưu');
                }
            });
        }

        // Delete book
        function deleteBook(bookId, bookTitle) {
            $('#deleteDetails').html(`<strong>Sách:</strong> ${bookTitle}`);
            
            $('#confirmDeleteBtn').off('click').on('click', function() {
                $.ajax({
                    url: '/Admin/DeleteBook',
                    type: 'POST',
                    data: { id: bookId },
                    success: function(response) {
                        $('#deleteModal').modal('hide');
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert('Lỗi: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        $('#deleteModal').modal('hide');
                        console.error('Error:', xhr);
                        alert('Có lỗi xảy ra khi xóa sách');
                    }
                });
            });
            
            $('#deleteModal').modal('show');
        }
    </script>
}